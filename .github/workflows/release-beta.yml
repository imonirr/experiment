name: Release (beta)

on:
  workflow_dispatch:

defaults:
  run:
    working-directory: nestjs

concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: true

jobs:
  release-candidate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - uses: actions/setup-node@v3
        with:
          node-version: 16
          cache: 'yarn'
          cache-dependency-path: nestjs/yarn.lock

      - name: Install packages
        run: yarn install --frozen-lockfile

      - name: Set commiter identity
        run: |
          git config --global user.name '${{ github.actor }}'
          git config --global user.email '${{ github.actor }}@users.noreply.github.com'

      - name: Generate changelog
        run: yarn run standard-version

      - name: Get release version
        id: 'release-version'
        uses: martinbeentjes/npm-get-version-action@main
        with:
          path: nestjs

      - name: Get release branch
        id: 'release-branch'
        run: echo "RELEASE_BRANCH=release-${{ steps.release-version.outputs.current-version}}" >> $GITHUB_OUTPUT


      # - name: Create release branch
      #   run: |
      #     git checkout -b ${{ steps.release-branch.outputs.RELEASE_BRANCH }}
      #     git push origin ${{ steps.release-branch.outputs.RELEASE_BRANCH }}

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v4
        with:
          base: main
          branch: ${{ steps.release-branch.outputs.RELEASE_BRANCH }}
          title: 'Release ${{ steps.release-version.outputs.current-version }}'
          body: |
            Update report
            - Auto-generated by [create-pull-request][1]

            [1]: https://github.com/peter-evans/create-pull-request

